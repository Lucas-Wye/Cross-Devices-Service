{{template "header.html" .}}

<div class="container">
    <h2>Admin Panel</h2>

    {{if .error}}
    <div class="alert alert-danger">{{.error}}</div>
    {{end}}

    <h3>Users</h3>
    <table class="table">
        <thead>
            <tr>
                <th>Username</th>
                <th>Role</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {{range .Users}}
            <tr>
                <td>{{.Username}}</td>
                <td>{{.Role}}</td>
                <td>
                    <form action="/admin/delete_user" method="post" style="display:inline;">
                        <input type="hidden" name="username" value="{{.Username}}">
                        <button type="submit" class="btn btn-danger btn-sm" {{if eq .Username "admin"}}disabled{{end}}>Delete</button>
                    </form>
                </td>
            </tr>
            {{end}}
        </tbody>
    </table>

    <hr>

    <h3>Add User</h3>
    <form action="/admin/add_user" method="post" class="form-inline">
        <div class="form-group">
            <label for="username">Username</label>
            <input type="text" name="username" class="form-control">
        </div>
        <div class="form-group">
            <label for="password">Password</label>
            <input type="password" name="password" class="form-control">
        </div>
        <div class="form-group">
            <label for="role">Role</label>
            <select name="role" class="form-control">
                <option value="user">User</option>
                <option value="admin">Admin</option>
            </select>
        </div>
        <button type="submit" class="btn btn-primary">Add User</button>
    </form>

    <hr>

    <h3>Edit Permissions</h3>
    <form action="/admin/update_permissions" method="post">
        <div class="form-group">
            <label for="username">User</label>
            <select name="username" class="form-control" id="user-select">
                {{range .Users}}
                <option value="{{.Username}}">{{.Username}}</option>
                {{end}}
            </select>
        </div>

        <div id="permissions-container">
            {{range .Users}}
            <div id="permissions-{{.Username}}" class="user-permissions" style="display:none;">
                <h4>Permissions for {{.Username}}</h4>
                <table class="table table-bordered permissions-list">
                    <thead>
                        <tr>
                            <th>Path</th>
                            <th>Read</th>
                            <th>Write</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .Permissions}}
                        <tr class="permission-item">
                            <td>
                                <input type="text" name="path[]" class="form-control" value="{{.Path}}">
                            </td>
                            <td class="text-center">
                                <input type="checkbox" name="read[]" class="form-check-input" value="{{.Path}}" {{if .Read}}checked{{end}}>
                            </td>
                            <td class="text-center">
                                <input type="checkbox" name="write[]" class="form-check-input" value="{{.Path}}" {{if .Write}}checked{{end}}>
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-danger btn-sm remove-permission">Remove</button>
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
                <div class="mb-3">
                    <button type="button" class="btn btn-success btn-sm add-permission">Add Permission</button>
                </div>
            </div>
            {{end}}
        </div>
    </br>
        <button type="submit" class="btn btn-primary">Update Permissions</button>
    </form>
</div>

    <script>
    document.getElementById('user-select').addEventListener('change', function() {
        var username = this.value;
        var allPermissions = document.querySelectorAll('.user-permissions');
        allPermissions.forEach(function(el) {
            el.style.display = 'none';
            // Disable all inputs within the hidden permission blocks
            el.querySelectorAll('input, button').forEach(function(input) {
                input.disabled = true;
            });
        });
        var userPermissions = document.getElementById('permissions-' + username);
        if (userPermissions) {
            userPermissions.style.display = 'block';
            // Enable inputs for the selected user
            userPermissions.querySelectorAll('input, button').forEach(function(input) {
                input.disabled = false;
            });
        }
    });    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('add-permission')) {
            var table = e.target.closest('.user-permissions').querySelector('table.permissions-list tbody');
            var newRow = document.createElement('tr');
            newRow.className = 'permission-item';
            newRow.innerHTML = `
                <td><input type="text" name="path[]" class="form-control" placeholder="Directory Path"></td>
                <td class="text-center"><input type="checkbox" name="read[]" class="form-check-input" value=""></td>
                <td class="text-center"><input type="checkbox" name="write[]" class="form-check-input" value=""></td>
                <td class="text-center"><button type="button" class="btn btn-danger btn-sm remove-permission">Remove</button></td>
            `;
            table.appendChild(newRow);

            // Sync checkbox values with the path input so backend can match by path
            var pathInput = newRow.querySelector('input[name="path[]"]');
            var readCb = newRow.querySelector('input[name="read[]"]');
            var writeCb = newRow.querySelector('input[name="write[]"]');
            var sync = function() {
                var v = pathInput.value;
                readCb.value = v;
                writeCb.value = v;
            };
            // Initial sync and attach listeners
            sync();
            pathInput.addEventListener('input', sync);
            pathInput.addEventListener('change', sync);
        }

        if (e.target && e.target.classList.contains('remove-permission')) {
            e.target.closest('.permission-item').remove();
        }
    });

    // Keep checkbox values in sync for existing rows when path changes (edit existing entries)
    document.addEventListener('input', function(e) {
        if (e.target && e.target.matches('input[name="path[]"]')) {
            var row = e.target.closest('.permission-item');
            if (!row) return;
            var v = e.target.value;
            var readCb = row.querySelector('input[name="read[]"]');
            var writeCb = row.querySelector('input[name="write[]"]');
            if (readCb) readCb.value = v;
            if (writeCb) writeCb.value = v;
        }
    });

    // Trigger change on load to show the first user's permissions
    document.getElementById('user-select').dispatchEvent(new Event('change'));
</script>

{{template "footer.html" .}}
